{% extends "base.html" %}
{% block title %}MoonLight ‚Äî –ü–µ—Ä–µ–≤–æ–¥—ã{% endblock %}
{% block page_title %}–ü–µ—Ä–µ–≤–æ–¥—ã{% endblock %}

{% block topbar_actions %}
<button class="btn btn-primary btn-sm" onclick="document.getElementById('create-modal').classList.add('open')">Ôºã –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
{% endblock %}

{% block content %}

{% set pending_list = transfers | selectattr('status', 'equalto', 'pending') | list %}
{% set approved_list = transfers | selectattr('status', 'equalto', 'approved') | list %}
{% set rejected_list = transfers | selectattr('status', 'equalto', 'rejected') | list %}

<!-- Stats row -->
<div class="stats-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:24px">
    <div class="stat-card gold">
        <div class="stat-value">{{ pending_list | length }}</div>
        <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
        <div class="stat-icon">‚è≥</div>
    </div>
    <div class="stat-card green">
        <div class="stat-value">{{ approved_list | length }}</div>
        <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω—ã</div>
        <div class="stat-icon">‚úì</div>
    </div>
    <div class="stat-card red">
        <div class="stat-value">{{ rejected_list | length }}</div>
        <div class="stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω—ã</div>
        <div class="stat-icon">‚úó</div>
    </div>
</div>

<!-- Pending -->
{% if pending_list %}
<div class="card" style="margin-bottom:20px;border-color:rgba(240,160,64,.3)">
    <div class="card-header">
        <div class="card-title" style="color:var(--orange)">‚è≥ –û–∂–∏–¥–∞—é—Ç —Ä–µ—à–µ–Ω–∏—è</div>
    </div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                    <th>–ö–æ–º—É</th>
                    <th>–û—Ç –∫–æ–≥–æ</th>
                    <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                    <th>–°–æ–∑–¥–∞–ª</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
            {% for t in pending_list %}
            <tr id="t-row-{{ t.id }}">
                <td>
                    <span style="font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;color:var(--accent)">{{ t.organization }}</span>
                </td>
                <td style="color:var(--text);font-weight:600">{{ t.to_name or '‚Äî' }}</td>
                <td style="color:var(--text2)">{{ t.from_name or '‚Äî' }}</td>
                <td style="color:var(--text2);font-size:13px;max-width:200px">{{ t.reason or '‚Äî' }}</td>
                <td style="color:var(--text3);font-size:12px">{{ t.creator_name or '‚Äî' }}</td>
                <td style="color:var(--text3);font-size:12px">{{ t.created_at[:10] }}</td>
                <td>
                    <div style="display:flex;gap:6px">
                        <button class="btn btn-success btn-sm" onclick="reviewTransfer({{ t.id }}, 'approved')">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
                        <button class="btn btn-danger btn-sm" onclick="reviewTransfer({{ t.id }}, 'rejected')">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- All Transfers -->
<div class="card">
    <div class="card-header">
        <div class="card-title">–í—Å–µ –ø–µ—Ä–µ–≤–æ–¥—ã</div>
        <div style="display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="filterStatus('')" id="f-all">–í—Å–µ</button>
            <button class="btn btn-ghost btn-sm" onclick="filterStatus('approved')" id="f-approved">–û–¥–æ–±—Ä–µ–Ω—ã</button>
            <button class="btn btn-ghost btn-sm" onclick="filterStatus('rejected')" id="f-rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω—ã</button>
        </div>
    </div>
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                    <th>–ö–æ–º—É</th>
                    <th>–û—Ç –∫–æ–≥–æ</th>
                    <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                    <th>–°–æ–∑–¥–∞–ª</th>
                    <th>–†–∞—Å—Å–º–æ—Ç—Ä–µ–ª</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞</th>
                </tr>
            </thead>
            <tbody id="transfers-tbody">
            {% for t in transfers %}
            <tr class="t-row" data-status="{{ t.status }}">
                <td>
                    <span style="font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--accent)">{{ t.organization }}</span>
                </td>
                <td style="color:var(--text);font-weight:600">{{ t.to_name or '‚Äî' }}</td>
                <td style="color:var(--text2)">{{ t.from_name or '‚Äî' }}</td>
                <td style="color:var(--text2);font-size:13px;max-width:180px">{{ (t.reason or '‚Äî')[:60] }}</td>
                <td style="color:var(--text3);font-size:12px">{{ t.creator_name or '‚Äî' }}</td>
                <td style="color:var(--text3);font-size:12px">{{ t.reviewer_name or '‚Äî' }}</td>
                <td><span class="badge badge-{{ t.status }}">{{ t.status }}</span></td>
                <td style="color:var(--text3);font-size:12px;white-space:nowrap">{{ t.created_at[:10] }}</td>
            </tr>
            {% else %}
            <tr><td colspan="8" style="text-align:center;color:var(--text3);padding:40px">–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Transfer Modal -->
<div class="modal-overlay" id="create-modal">
    <div class="modal">
        <div class="modal-title">üîÑ –ù–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥</div>

        <div class="form-group">
            <label class="form-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
            <select id="t-org" class="form-input">
                <option value="–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä">–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä</option>
                <option value="–í–µ—Å—Ç–Ω–∏–∫">–í–µ—Å—Ç–Ω–∏–∫</option>
                <option value="–ú–µ—Ü–µ–Ω–∞—Ç">–ú–µ—Ü–µ–Ω–∞—Ç</option>
                <option value="–õ–æ–≤–µ—Ü">–õ–æ–≤–µ—Ü</option>
                <option value="–†–∏—Ç—É–∞–ª–∏—Å—Ç">–†–∏—Ç—É–∞–ª–∏—Å—Ç</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–ö–æ–º—É (–ø–æ–ª—É—á–∞—Ç–µ–ª—å)</label>
            <select id="t-to" class="form-input">
                <option value="">‚Äî –ù–µ —É–∫–∞–∑–∞–Ω ‚Äî</option>
                {% for u in all_users %}
                <option value="{{ u.id }}">{{ u.username }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–û—Ç –∫–æ–≥–æ</label>
            <select id="t-from" class="form-input">
                <option value="">‚Äî –ù–µ —É–∫–∞–∑–∞–Ω ‚Äî</option>
                {% for u in all_users %}
                <option value="{{ u.id }}">{{ u.username }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞</label>
            <textarea id="t-reason" class="form-input" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–∞..." rows="3"></textarea>
        </div>

        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="document.getElementById('create-modal').classList.remove('open')">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="createTransfer()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function reviewTransfer(tid, decision) {
    const label = decision === 'approved' ? '–æ–¥–æ–±—Ä–∏—Ç—å' : '–æ—Ç–∫–ª–æ–Ω–∏—Ç—å';
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${label}?`)) return;
    const res = await apiFetch(`/transfers/${tid}/review`, { decision });
    if (res.ok) {
        const row = document.getElementById('t-row-' + tid);
        if (row) row.remove();
        toast(decision === 'approved' ? '–ü–µ—Ä–µ–≤–æ–¥ –æ–¥–æ–±—Ä–µ–Ω' : '–ü–µ—Ä–µ–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω—ë–Ω', decision === 'approved' ? 'success' : 'error');
        setTimeout(() => location.reload(), 1000);
    }
}

async function createTransfer() {
    const org = document.getElementById('t-org').value;
    const to = document.getElementById('t-to').value;
    const from = document.getElementById('t-from').value;
    const reason = document.getElementById('t-reason').value.trim();

    if (!org) { toast('–£–∫–∞–∂–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é', 'error'); return; }

    const res = await apiFetch('/transfers/create', {
        organization: org,
        to_user_id: to || null,
        from_user_id: from || null,
        reason: reason
    });

    if (res.ok) {
        document.getElementById('create-modal').classList.remove('open');
        toast('–ü–µ—Ä–µ–≤–æ–¥ —Å–æ–∑–¥–∞–Ω!', 'success');
        setTimeout(() => location.reload(), 800);
    } else {
        toast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è', 'error');
    }
}

function filterStatus(status) {
    document.querySelectorAll('.t-row').forEach(row => {
        row.style.display = (!status || row.dataset.status === status) ? '' : 'none';
    });
}

document.getElementById('create-modal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('open');
});

socket.on('transfer_created', () => { toast('–ù–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!'); });
socket.on('transfer_updated', () => location.reload());
</script>
{% endblock %}
